<!DOCTYPE html>
<html>
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulario de Registro</title>
<?!= HtmlService.createHtmlOutputFromFile('Estilos.css').getContent(); ?>
<style>
#cantidadCuotasContainer {
display: none;
}
/* (h) Estilo para el loader de aptitud */
#loader-aptitud {
display: none;
text-align: center;
margin-top: 10px;
}
/* Estilo para los campos din√°micos de tel√©fono */
.grupo-telefono {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 5px;
}
.grupo-telefono .telefono-parentezco {
    flex-grow: 1;
}
.grupo-telefono .telefono-area-code {
    width: 20%;
}
.grupo-telefono .telefono-numero {
    flex-grow: 2;
}
</style>
</head>
<body>


<div class="container">
<h1>Formulario de Inscripci√≥n</h1>
<h2>Colonia de Verano 2025</h2>


<div id="validacion-seccion">
<div class="form-section">
<h3>Paso 1: Verificaci√≥n de DNI</h3>
<label for="tipoInscripto">¬øEs un nuevo inscripto o ya particip√≥ en la colonia anteriormente?</label>
<select id="tipoInscripto" name="tipoInscripto" required>
<option value="nuevo">Soy Nuevo Inscripto</option>
<option value="anterior">Soy Inscripto Anterior</option>
</select>
<label for="dni-input">Ingrese el DNI del inscripto (sin puntos)</label>
<input type="text" id="dni-input" required pattern="\d{7,8}" maxlength="8" placeholder="Ej: 12345678">
<button type="button" id="btn-validar">Verificar DNI</button>
</div>
<div class="loader" id="loader-validacion">
<div class="spinner"></div>
<p>Verificando...</p>
</div>
<div class="status" id="status-validacion"></div>
<div id="timer-seccion">
<p>El cupo disponible se obtiene al confirmar el registro con todos los datos completos y el pago del mismo.</p>
<p>Cargando formulario en <strong id="timer-countdown">10</strong> segundos...</p>
</div>
</div>


<div id="registro-seccion" style="display:none;">
<form id="registroForm">
<div class="form-section">
<h3>Paso 2: Completar Datos del Inscripto</h3>
<label for="apellidoNombre">Apellido y Nombre Completo:</label>
<input type="text" id="apellidoNombre" name="apellidoNombre" class="form-cache" required>
<label for="dni">DNI: (sin puntos)</label>
<input type="text" id="dni" name="dni" class="form-cache" required readonly>
<label for="fechaNacimiento">Fecha de Nacimiento:</label>
<input type="date" id="fechaNacimiento" name="fechaNacimiento" class="form-cache" required>
<div id="edad-calculada"></div>
</div>


<div class="form-section">
<h3>Informaci√≥n Adicional</h3>
<label for="colegioJardin">Colegio / Jard√≠n:</label>
<input type="text" id="colegioJardin" name="colegioJardin" class="form-cache">
<label for="obraSocial">Obra Social:</label>
<input type="text" id="obraSocial" name="obraSocial" class="form-cache">
</div>


<div class="form-section">
<h3>Datos de Adultos Responsables</h3>
<label for="adultoResponsable1">Responsable 1: (Nombre y Apellido)</label>
<input type="text" id="adultoResponsable1" name="adultoResponsable1" class="form-cache" required>
<label for="adultoResponsable2">Responsable 2: (Nombre y Apellido)</label>
<input type="text" id="adultoResponsable2" name="adultoResponsable2" class="form-cache">
<label for="email">Email (Contacto Principal 1):</label>
<input type="email" id="email" name="email" class="form-cache" required>
<label>Tel√©fonos de Contacto</label>
<div id="telefonos-container">
    </div>
<button type="button" id="btn-add-telefono" class="btn-dinamico">Agregar Tel√©fono:</button>
<label style="margin-top: 20px;">Personas autorizadas a retirar:</label>
<div id="autorizados-container">
</div>
<button type="button" id="btn-add-autorizado" class="btn-dinamico">Agregar Autorizado:</button>
</div>




<div class="form-section">
<h3>Informaci√≥n de Salud</h3>
<div class="radio-group">
<label>¬øPractica alg√∫n deporte o actividad extracurricular?</label>
<label><input type="radio" name="practicaDeporte" value="S√≠" class="form-cache" required> S√≠</label>
<label><input type="radio" name="practicaDeporte" value="No" class="form-cache"> No</label>
</div>
<input type="text" id="especifiqueDeporte" name="especifiqueDeporte" class="form-cache" placeholder="Si la respuesta es s√≠, especifique cu√°l" style="display:none;">
<div class="radio-group">
<label>¬øTiene alguna enfermedad preexistente o medicaci√≥n especial?</label>
<label><input type="radio" name="tieneEnfermedad" value="S√≠" class="form-cache" required> S√≠</label>
<label><input type="radio" name="tieneEnfermedad" value="No" class="form-cache"> No</label>
</div>
<input type="text" id="especifiqueEnfermedad" name="especifiqueEnfermedad" class="form-cache" placeholder="Si la respuesta es s√≠, especifique" style="display:none;">
<div class="radio-group">
<label>¬øEs al√©rgico/a a algo?</label>
<label><input type="radio" name="esAlergico" value="S√≠" class="form-cache" required> S√≠</label>
<label><input type="radio" name="esAlergico" value="No" class="form-cache"> No</label>
</div>
<input type="text" id="especifiqueAlergia" name="especifiqueAlergia" class="form-cache" placeholder="Si la respuesta es s√≠, especifique" style="display:none;">
</div>




<div class="form-section">
<h3>Documentaci√≥n y Pago</h3>
<label for="certificadoAptitud">Certificado de Aptitud F√≠sica: (Opcional)</label>
<label for="certificadoAptitud" class="file-input-label">Seleccionar Certificado</label>
<input type="file" id="certificadoAptitud" name="certificadoAptitud" accept="image/jpeg, image/png, application/pdf">
<span id="certificadoAptitudName" class="file-name">Ning√∫n archivo seleccionado</span>
<div class="loader-archivo" id="loader-certificado"></div>
<input type="hidden" id="urlCertificadoAptitud" name="urlCertificadoAptitud">


<label for="fotoCarnet">Foto Carnet 4x4: (Requerida)</label>
<label for="fotoCarnet" class="file-input-label">Seleccionar Foto</label>
<input type="file" id="fotoCarnet" name="fotoCarnet" accept="image/jpeg, image/png">
<span id="fotoCarnetName" class="file-name">Ning√∫n archivo seleccionado</span>
<div class="loader-archivo" id="loader-foto"></div>
<input type="hidden" id="urlFotoCarnet" name="urlFotoCarnet">


<label for="jornada">Seleccione la Jornada:</label>
<span id="jornada-cupo-msg" style="display: none; color: #dc3545; font-weight: bold; font-size: 0.9em; margin-left: 10px;">(No hay cupo Jornada Extendida)</span>


<select id="jornada" name="jornada" class="form-cache" required>
<option value="">-- Por favor, elija una opci√≥n --</option>
<option value="Jornada Normal">Jornada Normal</option>
<option value="Jornada Normal extendida" id="opcion-jornada-extendida">Jornada Normal Extendida</option>
</select>




<label for="metodoPago">Seleccione el M√©todo de Pago</label>
<select id="metodoPago" name="metodoPago" class="form-cache" required>
<option value="">-- Por favor, elija una opci√≥n --</option>
<option value="Pago Online">Pago 1 Cuota Deb/Cred MP(Total)</option>
<option value="Pago en Cuotas">Pago 3 Cuotas (Online)</option>
<option value="Pago Efectivo y/o Transf.">Pago en Efectivo (En el local)</option>
</select>


<div id="cantidadCuotasContainer">
<label for="cantidadCuotas">Seleccione la cantidad de cuotas</label>
<select id="cantidadCuotas" name="cantidadCuotas">
<option value="1">1 Cuota</option>
<option value="2">2 Cuotas</option>
<option value="3">3 Cuotas</option>
</select>
</div>
</div>




<button type="submit" id="submit-button">Registrar y Continuar</button>
<button type="button" id="btn-limpiar-form">VOLVER (Limpiar Formulario)</button>




</form>
<div class="loader" id="loader-registro">
<div class="spinner"></div>
<p>Procesando registro... Por favor, espere.</p>
</div>
<div class="status" id="status-registro"></div>
</div>
</div>




<script>
const APP_URL = "<?= appUrl ?>";
const CACHE_KEY = 'formDataCache';
let numeroDeTurnoGuardado = null;
let telefonoCounter = 0; // Contador global para manejar IDs y requerimiento


// =========================================================
// DEFINICIONES DE FUNCIONES
// =========================================================


function handleRegistroSuccess(response) {
if (response.status === 'OK_REGISTRO') {
limpiarCache();
numeroDeTurnoGuardado = response.numeroDeTurno;
const loaderText = document.getElementById('loader-registro').querySelector('p');
loaderText.textContent = `¬°Registro guardado!! Creando link de pago y enviando email...`;


google.script.run
.withSuccessHandler(handlePagoSuccess)
.withFailureHandler(handlePagoFailure)
.paso2_crearPagoYEmail(response.datos, response.numeroDeTurno);


} else {
handleRegistroFailure(response);
}
}




function handleRegistroFailure(error) {
document.getElementById('submit-button').disabled = false;
document.getElementById('loader-registro').style.display = 'none';
const errorMessage = error.message || 'Ocurri√≥ un error desconocido al registrar.';
document.getElementById('status-registro').innerHTML = `<div class="mensaje error"><strong>Error al Registrar:</strong> ${errorMessage}</div>`;
}




/**
* (j) Estilos de Bot√≥n ELIMINADOS y reemplazados por CLASES CSS
*/
function handlePagoSuccess(response) {
document.getElementById('registroForm').style.display = 'none';
document.getElementById('loader-registro').style.display = 'none';
const statusDiv = document.getElementById('status-registro');


const mpIconHTML = `
<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 48 48">
<ellipse cx="23.5" cy="23.5" fill="#4fc3f7" rx="21.5" ry="15.5"></ellipse><path fill="#fafafa" d="M22.471,24.946c-1.978-5.537-4.884-10.881-6.085-12.995c-0.352-0.619-0.787-1.186-1.29-1.69 l-2.553-2.553c-0.391-0.391-1.414,0-1.414,0L9.497,8.734l-0.162,2.319L8.773,11c-0.518,0-0.938,0.42-0.938,0.938 c0,0.52,0.413,0.969,0.933,0.961c1.908-0.03,3.567,1.601,3.567,1.601h2c0.32,0.32,1.139,1.366,1.328,2.439 c0.107,0.611,0.154,1.229,0.119,1.848C15.458,24.622,16.835,26,16.835,26c-5.5-3.5-14.819-2.964-14.819-2.964l0.193,3.016L5,31 c0.919,0.212,0.744-0.626,1.765-0.504c6.199,0.741,13.57,0.004,13.57,0.004c1.5,0,1.958-0.793,2.665-1.5 C24,28,22.849,26.004,22.471,24.946z"></path><path fill="#fafafa" d="M24.913,24.946c1.978-5.537,4.884-10.881,6.085-12.995c0.352-0.619,0.787-1.186,1.29-1.69 l2.553-2.553c0.391-0.391,1.414,0,1.414,0L37.814,9l0.235,2.053L38.611,11c0.518,0,0.938,0.42,0.938,0.938 c0,0.52-0.413,0.969-0.933,0.961c-1.908-0.03-3.567,1.601-3.567,1.601h-2c-0.32,0.32-1.139,1.366-1.328,2.439 c-0.107,0.611-0.154,1.229-0.119,1.848C31.926,24.622,30.549,26,30.549,26c5.5-3.5,15-3,15-3l-0.165,3l-3,5 c-0.919,0.212-0.744-0.626-1.765-0.504c-6.199,0.741-13.57,0.004-13.57,0.004c-1.5,0-1.958-0.793-2.665-1.5 C23.384,28,24.535,26.004,24.913,24.946z"></path><path fill="#1a237e" d="M43.832,16.326c-0.311-0.415-0.644-0.808-0.992-1.187c-0.059-0.064-0.123-0.123-0.183-0.186 c-0.309-0.326-0.628-0.639-0.96-0.938c-0.026-0.023-0.053-0.045-0.079-0.068c-0.587-0.522-1.201-1.012-1.845-1.454 c0.071-0.175,0.11-0.364,0.11-0.555c0-0.792-0.643-1.437-1.481-1.437c-0.001,0-0.003,0-0.004,0l-0.015,0.002V9.32 c0-0.534-0.288-1.032-0.75-1.299L36.269,7.24c-0.221-0.085-1.356-0.478-1.946,0.113l-1.837,1.838 c-0.381-0.106-0.89-0.25-1.211-0.326C28.893,8.288,26.446,8.014,24,8c-3.031-0.004-6.095,0.39-9.018,1.275l-1.921-1.921 c-0.59-0.59-1.725-0.199-2.018-0.079L9.75,8.021C9.288,8.288,9,8.786,9,9.32v1.186L8.938,10.5c-0.793,0-1.438,0.646-1.438,1.438 c0,0.311,0.103,0.614,0.283,0.865c-0.978,0.715-1.903,1.512-2.722,2.422c-0.315,0.35-0.616,0.715-0.9,1.096 C2.638,18.346,2.061,20.87,2,23.5c-0.035,2.628,0.455,5.223,1.932,7.343c1.478,2.132,3.451,3.854,5.624,5.163 c4.378,2.609,9.436,3.749,14.444,3.846c2.511-0.026,5.023-0.319,7.471-0.924c2.442-0.624,4.81-1.582,6.986-2.9 c2.163-1.328,4.143-3.041,5.617-5.18c1.476-2.122,1.932-4.719,1.894-7.347C45.905,20.87,45.357,18.348,43.832,16.326z M40.793,15.139c0.229,0.225,0.448,0.459,0.662,0.697c0.096,0.107,0.195,0.211,0.288,0.32c0.293,0.347,0.573,0.703,0.828,1.076 c1.088,1.579,1.785,3.39,1.957,5.242c-2.274-0.031-8.444,0.114-13.042,2.342c0.335-1.133,0.619-3.016,0.449-6.058 c-0.03-0.552,0.008-1.135,0.113-1.733c0.139-0.79,0.702-1.618,1.054-2.026h0.727c0.731,0,1.432-0.224,2.025-0.647 c0.624-0.444,1.559-0.981,2.588-0.954c0.072,0,0.139-0.03,0.21-0.04c0.267,0.192,0.536,0.383,0.792,0.587 c0.076,0.061,0.15,0.124,0.225,0.186c0.273,0.224,0.538,0.457,0.795,0.696C40.576,14.93,40.686,15.034,40.793,15.139z M24,9 c2.369,0.026,4.734,0.303,7.027,0.87c0.208,0.053,0.412,0.118,0.617,0.181c-0.482,0.503-0.906,1.054-1.246,1.652 c-1.175,2.068-4.124,7.483-6.121,13.075c-0.075,0.208-0.163,0.43-0.255,0.66c-0.112,0.281-0.226,0.572-0.331,0.868 c-0.104-0.296-0.219-0.588-0.331-0.868c-0.092-0.23-0.18-0.452-0.255-0.66c-2-5.599-4.947-11.009-6.121-13.075 c-0.297-0.523-0.667-1.004-1.074-1.456C18.522,9.461,21.264,9.054,24,9z M5.435,17.238c0.251-0.364,0.524-0.713,0.811-1.052 c0.094-0.112,0.196-0.218,0.294-0.327c0.202-0.225,0.408-0.448,0.625-0.662c0.115-0.114,0.233-0.224,0.351-0.335 c0.229-0.213,0.463-0.421,0.704-0.622c0.099-0.083,0.198-0.166,0.299-0.247c0.243-0.193,0.495-0.376,0.748-0.558 c0.886,0.089,1.707,0.522,2.262,0.918C12.123,14.776,12.823,15,13.555,15h0.727c0.352,0.407,0.915,1.235,1.054,2.026 c0.105,0.597,0.143,1.18,0.113,1.733c-0.17,3.042,0.114,4.927,0.449,6.059c-4.193-2.029-9.734-2.333-12.425-2.344 C3.648,20.623,4.346,18.814,5.435,17.238z M6.236,30.271c-0.192-0.224-0.396-0.437-0.572-0.673 C4.329,27.826,3.49,25.705,3.426,23.5c0-0.008,0.001-0.017,0.001-0.025c2.878,0.006,9.226,0.351,13.305,2.947 c0.211,0.134,0.484,0.088,0.646-0.104c0.162-0.19,0.153-0.477-0.014-0.662c-0.012-0.014-1.218-1.422-0.916-6.842 c0.035-0.63-0.007-1.29-0.126-1.962c-0.218-1.235-1.133-2.372-1.467-2.706C14.76,14.053,14.632,14,14.5,14h-0.945 c-0.522,0-1.021-0.159-1.445-0.462c-0.745-0.531-1.925-1.147-3.185-1.14c-0.131,0.004-0.226-0.063-0.281-0.117 C8.552,12.192,8.5,12.067,8.5,11.938c0-0.242,0.196-0.438,0.391-0.44l0.562,0.054c0.111,0.007,0.216-0.027,0.308-0.084l0.386,0.386 C10.242,11.949,10.37,12,10.5,12c0.053,0,0.106-0.009,0.158-0.025l1.207-0.402l1.281,1.281C13.244,12.951,13.372,13,13.5,13 s0.256-0.049,0.354-0.146c0.195-0.195,0.195-0.512,0-0.707L12.707,11l0.146-0.146C12.951,10.756,13,10.628,13,10.5 s-0.049-0.256-0.146-0.354l-1-1c-0.195-0.195-0.512-0.195-0.707,0C11.049,9.244,11,9.372,11,9.5s0.049,0.256,0.146,0.354 l0.646,0.646l-0.063,0.063l-1.095,0.365L10,10.293V9.32c0-0.178,0.096-0.344,0.25-0.434l1.22-0.712 c0.365-0.139,0.792-0.179,0.883-0.114l2.554,2.554c0.475,0.475,0.882,1.007,1.209,1.583c1.161,2.043,4.076,7.393,6.049,12.917 c0.078,0.219,0.171,0.452,0.267,0.694c0.347,0.871,0.741,1.858,0.58,2.583C22.808,29.309,21.728,30,20.49,30 c-0.07,0.002-7.123,0.139-13.425,0.011C6.798,30.002,6.509,30.114,6.236,30.271z M37.217,33.918 c-1.98,1.119-4.156,1.898-6.385,2.419c-2.228,0.539-4.528,0.798-6.832,0.812c-4.592,0.01-9.259-0.951-13.23-3.208 c-1.401-0.799-2.709-1.764-3.832-2.891c0.036-0.014,0.083-0.038,0.107-0.039C13.367,31.138,20.439,31.001,20.5,31 c1.396,0,2.616-0.673,3.192-1.67c0.575,0.997,1.794,1.67,3.182,1.67c0.071,0.002,7.146,0.139,13.462,0.011 c0.089,0.003,0.272,0.102,0.483,0.249C39.748,32.289,38.531,33.185,37.217,33.918z M42.329,29.593 c-0.247,0.329-0.526,0.635-0.803,0.941c-0.37-0.273-0.81-0.524-1.192-0.524c-0.005,0-0.011,0-0.017,0 c-6.3,0.125-13.354-0.01-13.434-0.011c-1.228,0-2.308-0.691-2.512-1.608c-0.161-0.725,0.232-1.712,0.58-2.583 c0.096-0.242,0.189-0.476,0.267-0.694c1.971-5.518,4.887-10.871,6.049-12.917c0.327-0.576,0.734-1.108,1.209-1.583l2.55-2.551 C35.122,8,35.548,8.037,35.841,8.14l1.293,0.747c0.154,0.09,0.25,0.256,0.25,0.434v0.973l-0.635,0.635l-1.095-0.365L35.591,10.5 l0.646-0.646c0.098-0.098,0.146-0.226,0.146-0.354s-0.049-0.256-0.146-0.354c-0.195-0.195-0.512-0.195-0.707,0l-1,1 c-0.098,0.098-0.146,0.226-0.146,0.354s0.049,0.256,0.146,0.354l0.646,0.646l-0.063,0.063l-1.095,0.365L35.591,10.5 l0.646-0.646c0.098-0.098,0.146-0.226,0.146-0.354s-0.049-0.256-0.146-0.354c-0.195-0.195-0.512-0.195-0.707,0l-1,1 c-0.098,0.098-0.146,0.226-0.146,0.354s0.049,0.256,0.146,0.354L34.677,11l-1.146,1.146c-0.195,0.195-0.195,0.512,0,0.707 C33.628,12.951,33.756,13,33.884,13s0.256-0.049,0.354-0.146l1.281-1.281l1.207,0.402C36.777,11.991,36.831,12,36.884,12 c0.13,0,0.258-0.051,0.354-0.146l0.386-0.386c0.092,0.057,0.197,0.092,0.308,0.084l0.515-0.052c0.242,0,0.438,0.196,0.438,0.438 c0,0.129-0.052,0.254-0.143,0.343c-0.056,0.055-0.157,0.109-0.282,0.117c-1.279,0.011-2.439,0.608-3.185,1.14 C34.851,13.841,34.352,14,33.83,14h-0.946c-0.133,0-0.26,0.053-0.354,0.146c-0.334,0.334-1.25,1.473-1.467,2.706 c-0.118,0.674-0.161,1.334-0.126,1.963c0.302,5.419-0.904,6.827-0.907,6.831c-0.18,0.181-0.196,0.468-0.037,0.666 c0.159,0.199,0.442,0.246,0.659,0.109c4.408-2.805,11.576-2.969,13.922-2.942c0,0.007,0.001,0.013,0.001,0.02 C44.507,25.705,43.666,27.824,42.329,29.593z"></path>
</svg>
`;




if (response && response.status === 'OK_PAGO' && response.init_point) {
// (j) Asignar clases CSS en lugar de estilos en l√≠nea
statusDiv.innerHTML = `
<div class="mensaje exito">¬°Proceso inscripci√≥n completo!</div>
<p style="text-align:center; font-weight:bold; margin:20px 0;">Presione el bot√≥n para ir a la p√°gina de pago segura de Mercado Pago.</p>
<div id="btn-mp-container">
<a href="${response.init_point}" id="btn-ir-a-pagar" class="btn-final-pago" target="_top">
${mpIconHTML}Ir a Pagar a Mercado Pago
</a>
</div>
<button type="button" id="btn-volver-form-limpio" class="btn-final-volver">Volver a Iniciar (Formulario Limpio)</button>
`;




// Listener para el bot√≥n de volver
document.getElementById('btn-volver-form-limpio').addEventListener('click', function() {
window.top.location.href = APP_URL;
});




} else if (response && (response.status === 'OK_EFECTIVO' || response.status === 'OK_REGISTRO_SIN_PAGO')) {
// (j) Asignar clases CSS
statusDiv.innerHTML = `
<div class="mensaje exito">${response.message}</div>
<button type="button" id="btn-volver-form-limpio" class="btn-final-volver">Volver a Iniciar (Formulario Limpio)</button>
`;




document.getElementById('btn-volver-form-limpio').addEventListener('click', function() {
window.top.location.href = APP_URL;
});




} else if (response && response.status === 'OK_REGISTRO_SIN_LINK') {
// (j) Asignar clases CSS
statusDiv.innerHTML = `<div class="mensaje aviso">${response.message}</div>
<button type="button" id="btn-volver-form-limpio" class="btn-final-volver">Volver a Iniciar (Formulario Limpio)</button>
`;




document.getElementById('btn-volver-form-limpio').addEventListener('click', function() {
window.top.location.href = APP_URL;
});




} else {
const errorMessage = response.message || 'Ocurri√≥ un error desconocido en el paso 2.';
statusDiv.innerHTML = `<div class="mensaje error"><strong>Error:</strong> ${errorMessage}</div>`;
document.getElementById('registroForm').style.display = 'block';
document.getElementById('submit-button').disabled = false;
}
}




function handlePagoFailure(error) {
document.getElementById('submit-button').disabled = false;
document.getElementById('loader-registro').style.display = 'none';
document.getElementById('status-registro').innerHTML = `<div class="mensaje aviso">
<strong>¬°¬°REGISTRO GUARDADO!!</strong><br>
Pero ocurri√≥ un error al crear el link de pago o enviar el email: ${error.message}.
<br>Por favor, contacte a la administraci√≥n con su n√∫mero de turno.
</div>`;
}




/**
* (h) L√≥gica de Aptitud F√≠sica mejorada
*/
function handleValidationSuccess(response) {
document.getElementById('btn-validar').disabled = false;
document.getElementById('loader-validacion').style.display = 'none';
const statusDiv = document.getElementById('status-validacion');




if (response.status === 'OK' || response.status === 'OK_NUEVO') {
iniciarTemporizador(response);




} else if (response.status === 'DUPLICADO_PAGADO') {
statusDiv.innerHTML = `<div class="mensaje exito"><strong>Aviso:</strong> ${response.message}</div>`;
// (a) L√≥gica para Aptitud F√≠sica
if (response.adeudaAptitud === true) {
let htmlAptitud = `
<div id="aptitud-manual-seccion" style="margin-top: 15px; padding: 10px; border: 1px solid #e67e22; border-radius: 5px; background: #fdf5e6;">
<h3 style="background-color: #e67e22; color: white; padding: 10px;">¬°Atenci√≥n!</h3>
<p style="text-align: center; font-weight: bold; color: #e67e22;">Adeuda Certificado de Aptitud F√≠sica</p>
<p>Por favor, suba el certificado para completar la ficha.</p>
<label for="aptitud-manual-upload" class="file-input-label" style="background-color: #e67e22;">Seleccionar Certificado</label>
<input type="file" id="aptitud-manual-upload" accept="image/jpeg, image/png, application/pdf">
<span id="aptitud-manual-name" class="file-name">Ning√∫n archivo seleccionado</span>
<button type="button" id="btn-submit-aptitud-manual" style="background-color: #e67e22; width: 100%; height:45px">Subir Certificado!!!</button>
<div class="loader" id="loader-aptitud" style="display: none;"><div class="spinner"></div><p>Subiendo...</p></div>
</div>`;
statusDiv.innerHTML += htmlAptitud;




document.getElementById('aptitud-manual-upload').addEventListener('change', function() {
document.getElementById('aptitud-manual-name').textContent = this.files[0] ? this.files[0].name : 'Ning√∫n archivo seleccionado';
});
document.getElementById('btn-submit-aptitud-manual').addEventListener('click', submitAptitudManual);
}




} else if (response.status === 'DUPLICADO_PENDIENTE_PAGO' ||
response.status === 'DUPLICADO_PENDIENTE_EFECTIVO' ||
response.status === 'DUPLICADO_PENDIENTE_ERROR') {




let html = `<div class="mensaje error" style="text-align:left;"><strong>${response.message}</strong></div>`;




// (L) Si es un error de repago, no mostramos el bot√≥n de pago.
if (response.status === 'DUPLICADO_PENDIENTE_PAGO' && response.init_point) {
html += `
<p style="text-align:center; font-weight:bold; margin-top:15px;">Para completar la inscripci√≥n, elija una opci√≥n:</p>
<button type="button" id="btn-pagar-pendiente">1. Pagar Ahora con Mercado Pago</button>
`;
}




html += `
<div id="comprobante-manual-seccion">
<h3>2. Si ya abon√≥, suba su comprobante:</h3>
<p>Puede subir una captura de pantalla, foto del ticket o PDF.</p>
<label for="comprobante-manual-upload" class="file-input-label" style="background-color: #7f8c8d;">Seleccionar Archivo para Subir</label>
<input type="file" id="comprobante-manual-upload" accept="image/jpeg, image/png, application/pdf">
<span id="comprobante-manual-name" class="file-name">Ning√∫n archivo seleccionado</span>
<button type="button" id="btn-cancelar-upload">Cancelar</button>
</div>
`;




statusDiv.innerHTML = html;




document.getElementById('comprobante-manual-upload').addEventListener('change', function() {
const file = this.files[0];
if (!file) {
document.getElementById('comprobante-manual-name').textContent = 'Ning√∫n archivo seleccionado';
return;
}
document.getElementById('comprobante-manual-name').textContent = file.name;
const dni = document.getElementById('dni-input').value;
this.disabled = true;
const btnCancelar = document.getElementById('btn-cancelar-upload');
if(btnCancelar) btnCancelar.disabled = true;
const btnPagarPendiente = document.getElementById('btn-pagar-pendiente');
if(btnPagarPendiente) btnPagarPendiente.disabled = true;
document.getElementById('loader-validacion').style.display = 'block';
document.getElementById('loader-validacion').querySelector('p').textContent = "Subiendo comprobante...";
comprimirYLeerArchivo(file).then(fileData => {
google.script.run
.withSuccessHandler(handleComprobanteUploadSuccess)
.withFailureHandler(handleValidationFailure)
.subirComprobanteManual(dni, fileData);
}).catch(err => {
handleValidationFailure(err);
});
});




const btnPagar = document.getElementById('btn-pagar-pendiente');
if (btnPagar) {
btnPagar.addEventListener('click', function() {
this.disabled = true;
this.textContent = "Redirigiendo...";
window.top.location.href = response.init_point;
});
}
document.getElementById('btn-cancelar-upload').addEventListener('click', function() {
window.top.location.href = APP_URL;
});




} else if (response.status === 'ERROR_TIPO_NUEVO' || response.status === 'ERROR_TIPO_ANT' || response.status === 'YA_REGISTRADO' || response.status === 'ANULADO' || response.status === 'NO_ENCONTRADO_ANT') {
statusDiv.innerHTML = `<div class="mensaje error"><strong>Aviso:</strong> ${response.message}</div>`;
} else {
statusDiv.innerHTML = `<div class="mensaje error"><strong>Aviso:</strong> ${response.message}</div>`;
}
}




function handleValidationFailure(error) {
document.getElementById('btn-validar').disabled = false;
document.getElementById('loader-validacion').style.display = 'none';
document.getElementById('status-validacion').innerHTML = `<div class="mensaje error"><strong>Error de Conexi√≥n:</strong> ${error.message}</div>`;
const fileInputManual = document.getElementById('comprobante-manual-upload');
if (fileInputManual) {
fileInputManual.disabled = false;
fileInputManual.value = '';
document.getElementById('comprobante-manual-name').textContent = 'Ning√∫n archivo seleccionado';
}
const btnCancelar = document.getElementById('btn-cancelar-upload');
if(btnCancelar) btnCancelar.disabled = false;
const btnPagarPendiente = document.getElementById('btn-pagar-pendiente');
if(btnPagarPendiente) btnPagarPendiente.disabled = false;
}




/**
* (h) Progreso y bot√≥n verde para Aptitud F√≠sica
*/
function submitAptitudManual() {
const fileInput = document.getElementById('aptitud-manual-upload');
const file = fileInput.files[0];
const dni = document.getElementById('dni-input').value;
const loader = document.getElementById('loader-aptitud');
const btn = document.getElementById('btn-submit-aptitud-manual');




if (!file) {
alert("Por favor, seleccione un archivo primero.");
return;
}




loader.style.display = 'block';
btn.disabled = true;
fileInput.disabled = true;




comprimirYLeerArchivo(file).then(fileData => {
google.script.run
.withSuccessHandler(handleAptitudUploadSuccess)
.withFailureHandler(handleAptitudUploadFailure)
.subirAptitudManual(dni, fileData);
}).catch(err => {
handleAptitudUploadFailure(err);
});
}




/**
* (N) Redirecci√≥n a√±adida
*/
function handleAptitudUploadSuccess(response) {
const loader = document.getElementById('loader-aptitud');
const seccion = document.getElementById('aptitud-manual-seccion');
const btn = document.getElementById('btn-submit-aptitud-manual');
const fileInput = document.getElementById('aptitud-manual-upload');
const fileName = document.getElementById('aptitud-manual-name');
const fileLabel = document.querySelector('label[for="aptitud-manual-upload"]');




loader.style.display = 'none';




if (response.status === 'OK') {
// Cambia el bot√≥n a verde
btn.style.backgroundColor = 'var(--color-exito, #28a745)';
btn.textContent =  '‚úÖ ¬°Subido con √âxito!' ;
btn.disabled = true;


// Oculta los controles de subida
fileInput.style.display = 'none';
fileName.style.display = 'none';
fileLabel.style.display = 'none';




// Muestra un mensaje de √©xito
const successMsg = document.createElement('div');
successMsg.className = 'mensaje exito';
successMsg.style.marginTop = '10px';
successMsg.textContent = response.message;
seccion.appendChild(successMsg);




// (N) ¬°¬°¬°NUEVO!!! Redireccionar al inicio
setTimeout(() => {
window.top.location.href = APP_URL;
}, 3000); // 3 segundos para leer el mensaje




} else {
// Muestra error pero mantiene controles activos
seccion.innerHTML += `<div class="mensaje error">${response.message}</div>`;
btn.disabled = false;
fileInput.disabled = false;
}
}




function handleAptitudUploadFailure(error) {
const loader = document.getElementById('loader-aptitud');
loader.style.display = 'none';
const seccion = document.getElementById('aptitud-manual-seccion');
seccion.innerHTML += `<div class="mensaje error">Error: ${error.message}</div>`;
document.getElementById('btn-submit-aptitud-manual').disabled = false;
document.getElementById('aptitud-manual-upload').disabled = false;
}




function handleComprobanteUploadSuccess(response) {
document.getElementById('loader-validacion').style.display = 'none';
const statusDiv = document.getElementById('status-validacion');
if (response.status === 'OK') {
statusDiv.innerHTML = `<div class="mensaje exito">${response.message}</div>`;
setTimeout(() => {
window.top.location.href = APP_URL;
}, 3000);
} else {
statusDiv.innerHTML = `<div class="mensaje error">${response.message}</div>`;
const fileInputManual = document.getElementById('comprobante-manual-upload');
if (fileInputManual) {
fileInputManual.disabled = false;
fileInputManual.value = '';
document.getElementById('comprobante-manual-name').textContent = 'Ning√∫n archivo seleccionado';
}
const btnCancelar = document.getElementById('btn-cancelar-upload');
if(btnCancelar) btnCancelar.disabled = false;
const btnPagarPendiente = document.getElementById('btn-pagar-pendiente');
if(btnPagarPendiente) btnPagarPendiente.disabled = false;
}
}




function iniciarTemporizador(response) {
document.getElementById('timer-seccion').style.display = 'block';
document.getElementById('btn-validar').disabled = true;
let segundos = 8;
const countdown = document.getElementById('timer-countdown');
countdown.textContent = segundos;
const interval = setInterval(() => {
segundos--;
countdown.textContent = segundos;
if (segundos <= 0) {
clearInterval(interval);
mostrarFormulario(response);
}
}, 800);
}




function mostrarFormulario(response) {
document.getElementById('validacion-seccion').style.display = 'none';
document.getElementById('registro-seccion').style.display = 'block';


document.getElementById('dni').value = response.datos.dni;


if (response.status === 'OK' && response.datos) {
document.getElementById('apellidoNombre').value = response.datos.nombreCompleto || '';
document.getElementById('fechaNacimiento').value = response.datos.fechaNacimiento || '';
document.getElementById('obraSocial').value = response.datos.obraSocial || '';
document.getElementById('colegioJardin').value = response.datos.colegioJardin || '';
document.getElementById('adultoResponsable1').value = response.datos.adultoResponsable || '';
}


// üõë --- INICIO DE LA CORRECCI√ìN DE CUPO JORNADA EXTENDIDA --- üõë
// Verificamos si la jornada extendida alcanz√≥ el l√≠mite
if (response.jornadaExtendidaAlcanzada === true) {


// 1. Deshabilitar la opci√≥n
const opcionExtendida = document.getElementById('opcion-jornada-extendida');
if (opcionExtendida) {
opcionExtendida.disabled = true;
opcionExtendida.textContent = "Jornada Extendida (SIN CUPO)";
}


// 2. Mostrar el mensaje de advertencia
const msgCupo = document.getElementById('jornada-cupo-msg');
if (msgCupo) {
msgCupo.style.display = 'inline'; // Mostrar el mensaje
}
}
// üõë --- FIN DE LA CORRECCI√ìN DE CUPO --- üõë


guardarFormEnCache();
calcularYMostrarEdad();
toggleEspecifique('practicaDeporte', 'especifiqueDeporte');
toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad');
toggleEspecifique('esAlergico', 'especifiqueAlergia');
toggleCantidadCuotas();
}




function comprimirYLeerArchivo(file) {
const MAX_WIDTH = 1024;
const QUALITY = 0.7;
const mimeType = file.type;




return new Promise((resolve, reject) => {
if (mimeType !== 'image/jpeg' && mimeType !== 'image/png') {
readFileAsBase64(file).then(data => {
resolve({ data, mimeType, fileName: file.name });
}).catch(reject);
return;
}




const reader = new FileReader();
reader.onload = (e) => {
const img = new Image();
img.onload = () => {
let width = img.width;
let height = img.height;
if (width > height) {
if (width > MAX_WIDTH) {
height *= MAX_WIDTH / width;
width = MAX_WIDTH;
}
} else {
if (height > MAX_WIDTH) {
width *= MAX_WIDTH / height;
height = MAX_WIDTH;
}
}
const canvas = document.createElement('canvas');
canvas.width = width;
canvas.height = height;
const ctx = canvas.getContext('2d');
ctx.drawImage(img, 0, 0, width, height);
const compressedData = canvas.toDataURL('image/jpeg', QUALITY);
resolve({
data: compressedData,
mimeType: 'image/jpeg',
fileName: file.name.replace(/\.[^/.]+$/, "") + ".jpg"
});
};
img.onerror = reject;
img.src = e.target.result;
};
reader.onerror = reject;
reader.readAsDataURL(file);
});
}




function manejarSubidaArchivo(inputElement, tipoArchivo, nombreLabelId, loaderId, urlHiddenId) {
const file = inputElement.files[0];
const nombreLabel = document.getElementById(nombreLabelId);
const loader = document.getElementById(loaderId);
const urlHidden = document.getElementById(urlHiddenId);
const dni = document.getElementById('dni').value;




urlHidden.value = '';
loader.style.display = 'none';
nombreLabel.textContent = 'Ning√∫n archivo seleccionado';
if (!file) return;




if (!dni) {
alert("Error: No se puede subir un archivo si el DNI no est√° cargado en el formulario (Paso 2).");
inputElement.value = '';
return;
}




nombreLabel.textContent = file.name;
loader.className = 'loader-archivo';
loader.style.display = 'block';
loader.textContent = 'Iniciando...';




inputElement.disabled = true;
document.getElementById('submit-button').disabled = true;




loader.textContent = 'Preparando archivo (comprimiendo si es imagen)...';
comprimirYLeerArchivo(file).then(fileData => {
loader.textContent = 'Subiendo archivo...';
google.script.run
.withSuccessHandler(function(response) {
inputElement.disabled = false;
document.getElementById('submit-button').disabled = false;
if (response.status === 'OK') {
loader.className = 'loader-archivo exito';
loader.textContent =  '‚úÖ Archivo subido con √©xito.' ;
urlHidden.value = response.url;
} else {
loader.className = 'loader-archivo error';
loader.textContent =  `‚ùå Error:  ${response.message}`;
inputElement.value = '';
nombreLabel.textContent = 'Ning√∫n archivo seleccionado';
}
})
.withFailureHandler(function(error) {
inputElement.disabled = false;
document.getElementById('submit-button').disabled = false;
loader.className = 'loader-archivo error';
loader.textContent =  `‚ùå Error de conexi√≥n:  ${error.message}`;
inputElement.value = '';
nombreLabel.textContent = 'Ning√∫n archivo seleccionado';
})
.subirArchivoIndividual(fileData, dni, tipoArchivo);
}).catch(err => {
inputElement.disabled = false;
document.getElementById('submit-button').disabled = false;
loader.className = 'loader-archivo error';
loader.textContent =  `‚ùå Error al procesar el archivo:  ${err.message}`;
inputElement.value = '';
nombreLabel.textContent = 'Ning√∫n archivo seleccionado';
});
}




function calcularYMostrarEdad() {
const fechaNacimientoStr = document.getElementById('fechaNacimiento').value;
const divEdad = document.getElementById('edad-calculada');
if (!fechaNacimientoStr) {
divEdad.textContent = '';
return;
}
const fechaNacimiento = new Date(fechaNacimientoStr);
const hoy = new Date();
fechaNacimiento.setMinutes(fechaNacimiento.getMinutes() + fechaNacimiento.getTimezoneOffset());
let anos = hoy.getFullYear() - fechaNacimiento.getFullYear();
let meses = hoy.getMonth() - fechaNacimiento.getMonth();
let dias = hoy.getDate() - fechaNacimiento.getDate();
if (dias < 0) {
meses--;
dias += new Date(hoy.getFullYear(), hoy.getMonth(), 0).getDate();
}
if (meses < 0) {
anos--;
meses += 12;
}
if (anos >= 0) {
divEdad.textContent = `Edad actual: ${anos} a√±os, ${meses} meses y ${dias} d√≠as.`;
} else {
divEdad.textContent = '';
}
}




function toggleEspecifique(radioName, inputId) {
const radioChecked = document.querySelector(`input[name="${radioName}"]:checked`);
const inputField = document.getElementById(inputId);
if (radioChecked && radioChecked.value === 'S√≠') {
inputField.style.display = 'block';
} else {
inputField.style.display = 'none';
inputField.value = '';
}
}




function toggleCantidadCuotas() {
const metodoPago = document.getElementById('metodoPago').value;
const container = document.getElementById('cantidadCuotasContainer');
const selectCuotas = document.getElementById('cantidadCuotas');
if (metodoPago === 'Pago en Cuotas') {
container.style.display = 'block';
selectCuotas.classList.add('form-cache');
selectCuotas.required = true;
} else {
container.style.display = 'none';
selectCuotas.classList.remove('form-cache');
selectCuotas.required = false;
selectCuotas.value = '1';
}
}




function removerFila(boton) {
    boton.parentElement.remove();
    // Reajustar el requerimiento si se elimina el √∫nico campo
    const telefonos = document.querySelectorAll('.telefono-area-code');
    if (telefonos.length === 0) {
        // Si no queda ninguno, volvemos a a√±adir el primero para cumplir el required
        addTelefonoCampos(true);
    }
    guardarFormEnCache();
}




function readFileAsBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = () => resolve(reader.result);
reader.onerror = (error) => reject(error);
reader.readAsDataURL(file);
});
}




/**
 * NUEVA FUNCI√ìN: Genera e inserta los campos de tel√©fono con validaci√≥n.
 * @param {boolean} isRequired Indica si los campos deben tener el atributo required.
 */
function addTelefonoCampos(isRequired = false) {
    const container = document.getElementById('telefonos-container');
    const div = document.createElement('div');
    div.className = 'fila-dinamica';
    div.innerHTML = `
        <input type="text" class="telefono-parentezco form-cache" placeholder="Parentezco (ej: Madre)">
        <div class="grupo-telefono" style="flex-grow: 1;">
            <input
                type="tel"
                class="telefono-area-code form-cache"
                placeholder="Cod. √Årea (sin 0)"
                ${isRequired ? 'required' : ''}
                pattern="^[1-9][0-9]{1,4}$"
                title="Ingrese el C√≥digo de √Årea sin el 0 inicial."
            >
            <input
                type="tel"
                class="telefono-numero form-cache"
                placeholder="N√∫mero (sin 15)"
                ${isRequired ? 'required' : ''}
                pattern="^[0-9]{6,10}$"
                title="Ingrese el n√∫mero de tel√©fono sin el 15 inicial."
            >
        </div>
        <button type="button" class="btn-remover" onclick="removerFila(this)">X</button>
    `;
    container.appendChild(div);
    telefonoCounter++; // Incrementa el contador por si se necesita saber cu√°ntos hay
}




function guardarFormEnCache() {
try {
const data = {};
document.querySelectorAll('.form-cache').forEach(el => {
const key = el.id || el.name;
if (el.type === 'radio') {
if (el.checked) {
data[el.name] = el.value;
}
} else {
if(key === 'cantidadCuotas' && document.getElementById('metodoPago').value !== 'Pago en Cuotas' ) {
data[key] = 0;
} else {
data[key] = el.value;
}
}
});


// Guardado de Tel√©fonos con la nueva estructura
data.telefonos = [];
const parentezcos = document.querySelectorAll('.telefono-parentezco');
const codigosArea = document.querySelectorAll('.telefono-area-code');
const numeros = document.querySelectorAll('.telefono-numero');
for (let i = 0; i < parentezcos.length; i++) {
    // Solo guardar si hay datos para evitar guardar filas vac√≠as de cach√©
    if (parentezcos[i].value || codigosArea[i].value || numeros[i].value) {
        data.telefonos.push({
            p: parentezcos[i].value,
            a: codigosArea[i].value, // 'a' para area code
            n: numeros[i].value
        });
    }
}


data.autorizados = [];
const nombresAut = document.querySelectorAll('.autorizado-nombre');
const dnisAut = document.querySelectorAll('.autorizado-dni');
for (let i = 0; i < dnisAut.length; i++) {
if (nombresAut[i].value && dnisAut[i].value) {
data.autorizados.push({ n: nombresAut[i].value, d: dnisAut[i].value });
}
}
localStorage.setItem(CACHE_KEY, JSON.stringify(data));
} catch(e) {
console.warn("No se pudo guardar el cach√© del formulario: ", e);
}
}




function cargarFormDesdeCache() {
try {
const data = JSON.parse(localStorage.getItem(CACHE_KEY));
if (!data) return;


document.querySelectorAll('.form-cache').forEach(el => {
const key = el.id || el.name;
if (data[key] !== undefined) {
if (el.type === 'radio') {
el.checked = (el.value === data[key]);
} else {
el.value = data[key];
}
}
});


// Carga de Tel√©fonos desde cach√© (nueva estructura)
if (data.telefonos && data.telefonos.length > 0) {
    const telContainer = document.getElementById('telefonos-container');
    telContainer.innerHTML = '';
   
    data.telefonos.forEach((tel, index) => {
        const div = document.createElement('div');
        div.className = 'fila-dinamica';
       
        // Determinar si es requerido (solo el primero)
        const isRequired = (index === 0);


        div.innerHTML = `
            <input type="text" class="telefono-parentezco form-cache" placeholder="Parentezco (ej: Madre)" value="${tel.p || ''}">
            <div class="grupo-telefono" style="flex-grow: 1;">
                <input
                    type="tel"
                    class="telefono-area-code form-cache"
                    placeholder="Cod. √Årea (sin 0)"
                    value="${tel.a || ''}"
                    ${isRequired ? 'required' : ''}
                    pattern="^[1-9][0-9]{1,4}$"
                    title="Ingrese el C√≥digo de √Årea sin el 0 inicial."
                >
                <input
                    type="tel"
                    class="telefono-numero form-cache"
                    placeholder="N√∫mero (sin 15)"
                    value="${tel.n || ''}"
                    ${isRequired ? 'required' : ''}
                    pattern="^[0-9]{6,10}$"
                    title="Ingrese el n√∫mero de tel√©fono sin el 15 inicial."
                >
            </div>
            <button type="button" class="btn-remover" onclick="removerFila(this)">X</button>
        `;
        telContainer.appendChild(div);
        telefonoCounter++;
    });


} else {
    // Si no hay datos de cach√©, asegurar que se a√±ade el primer campo requerido
    addTelefonoCampos(true);
}


if (data.autorizados) {
const autContainer = document.getElementById('autorizados-container');
autContainer.innerHTML = '';
data.autorizados.forEach(aut => {
const div = document.createElement('div');
div.className = 'fila-dinamica';
div.innerHTML = `
<div class="campos-dinamicos">
<input type="text" class="autorizado-nombre form-cache" placeholder="Nombre y Apellido (Relaci√≥n):" value="${aut.n || ''}">
<input type="text" class="autorizado-dni form-cache" placeholder="DNI" maxlength="8" pattern="\\d{7,8}" value="${aut.d || ''}">
</div>
<button type="button" class="btn-remover" onclick="removerFila(this)">X</button>
`;
autContainer.appendChild(div);
});
}
calcularYMostrarEdad();
} catch(e) {
console.warn("No se pudo cargar el cach√© del formulario: ", e);
}
}




function limpiarCache() {
localStorage.removeItem(CACHE_KEY);
}




// =========================================================
// LISTENERS DE EVENTOS
// =========================================================




document.getElementById('btn-validar').addEventListener('click', function() {
const dni = document.getElementById('dni-input').value;
const tipo = document.getElementById('tipoInscripto').value;
if (!dni) {
document.getElementById('status-validacion').innerHTML = '<div class="mensaje error">Por favor, ingrese un DNI.</div>';
return;
}
document.getElementById('btn-validar').disabled = true;
document.getElementById('loader-validacion').style.display = 'block';
document.getElementById('status-validacion').innerHTML = '';
google.script.run
.withSuccessHandler(handleValidationSuccess)
.withFailureHandler(handleValidationFailure)
.validarAcceso(dni, tipo);
});




document.getElementById('fotoCarnet').addEventListener('change', function() {
manejarSubidaArchivo(this, 'foto', 'fotoCarnetName', 'loader-foto', 'urlFotoCarnet');
});
document.getElementById('certificadoAptitud').addEventListener('change', function() {
manejarSubidaArchivo(this, 'ficha', 'certificadoAptitudName', 'loader-certificado', 'urlCertificadoAptitud');
});




document.getElementById('fechaNacimiento').addEventListener('change', calcularYMostrarEdad);




document.querySelectorAll('input[name="practicaDeporte"]').forEach(el => el.addEventListener('change', () => toggleEspecifique('practicaDeporte', 'especifiqueDeporte')));
document.querySelectorAll('input[name="tieneEnfermedad"]').forEach(el => el.addEventListener('change', () => toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad')));
document.querySelectorAll('input[name="esAlergico"]').forEach(el => el.addEventListener('change', () => toggleEspecifique('esAlergico', 'especifiqueAlergia')));




document.getElementById('metodoPago').addEventListener('change', toggleCantidadCuotas);




/**
 * Listener modificado para usar la nueva funci√≥n addTelefonoCampos
 * NOTA: Siempre a√±ade campos que NO son requeridos (ya que el primero ya fue a√±adido o ser√° verificado).
 */
document.getElementById('btn-add-telefono').addEventListener('click', function() {
    addTelefonoCampos(false);
    guardarFormEnCache();
});




document.getElementById('btn-add-autorizado').addEventListener('click', function() {
const container = document.getElementById('autorizados-container');
const div = document.createElement('div');
div.className = 'fila-dinamica';
div.innerHTML = `
<div class="campos-dinamicos">
<input type="text" class="autorizado-nombre form-cache" placeholder="Nombre y Apellido (Relaci√≥n)">
<input type="text" class="autorizado-dni form-cache" placeholder="DNI" maxlength="8" pattern="\\d{7,8}">
</div>
<button type="button" class="btn-remover" onclick="removerFila(this)">X</button>
`;
container.appendChild(div);
guardarFormEnCache();
});




document.getElementById('registroForm').addEventListener('submit', function(e) {
e.preventDefault();


// --- VALIDACI√ìN ADICIONAL DE TEL√âFONO REQUERIDO ---
// Si no hay campos, la validaci√≥n HTML no se ejecuta, as√≠ que forzamos la creaci√≥n del primero
const telefonosRequeridos = document.querySelectorAll('.telefono-area-code[required]');
if (telefonosRequeridos.length === 0) {
    alert('Debe ingresar al menos un tel√©fono de contacto (C√≥digo de √Årea y N√∫mero).');
    document.getElementById('btn-add-telefono').scrollIntoView({ behavior: 'smooth' });
    return;
}
// ----------------------------------------------------




document.getElementById('submit-button').disabled = true;
document.getElementById('loader-registro').style.display = 'block';
document.getElementById('loader-registro').querySelector('p').textContent = 'Procesando registro... Por favor, espere.';
document.getElementById('status-registro').innerHTML = '';




const form = e.target;
const formDataObject = {};


document.querySelectorAll('.form-cache').forEach(el => {
const key = el.id || el.name;
if (el.type === 'radio') {
if (el.checked) {
formDataObject[key] = el.value;
}
} else {
if (key === 'cantidadCuotas') {
if(document.getElementById('metodoPago').value !== 'Pago en Cuotas') {
formDataObject[key] = 0;
} else {
formDataObject[key] = el.value;
}
} else {
formDataObject[key] = el.value;
}
}
});




// (e) A√±ade el tipo de inscripto
formDataObject.tipoInscripto = document.getElementById('tipoInscripto').value;




formDataObject.urlCertificadoAptitud = document.getElementById('urlCertificadoAptitud').value;
formDataObject.urlFotoCarnet = document.getElementById('urlFotoCarnet').value;


// --- RECOLECCI√ìN DE TEL√âFONOS CON NUEVA ESTRUCTURA ---
const telefonos = [];
const parentezcos = document.querySelectorAll('.telefono-parentezco');
const codigosArea = document.querySelectorAll('.telefono-area-code');
const numeros = document.querySelectorAll('.telefono-numero');
for (let i = 0; i < parentezcos.length; i++) {
    const parentesco = parentezcos[i].value;
    const codArea = codigosArea[i].value;
    const numero = numeros[i].value;


    // Solo agregar si al menos se ingres√≥ el c√≥digo de √°rea O el n√∫mero,
    // o el parentesco para no enviar filas completamente vac√≠as
    if (parentesco || codArea || numero) {
        // Formato para la celda: (Parentesco - CodArea) N√∫mero
        // Si el n√∫mero o el cod. √°rea faltan (pero no son requeridos), se pone 'N/A' o se deja vac√≠o para evitar errores de formato
        const telefonoCompleto = `${(parentesco || 'N/A').trim()};${(codArea || 'N/A').trim()};${(numero || 'N/A').trim()}`;
        telefonos.push(telefonoCompleto);
    }
}
// Guardamos el array como un string separado por punto y coma (para una sola celda)
formDataObject.telefonosContacto = telefonos.join(' | ');
// ------------------------------------------------------




const autorizados = [];
const nombresAut = document.querySelectorAll('.autorizado-nombre');
const dnisAut = document.querySelectorAll('.autorizado-dni');
for (let i = 0; i < dnisAut.length; i++) {
if (nombresAut[i].value && dnisAut[i].value) {
autorizados.push(`${nombresAut[i].value.trim()} (DNI: ${dnisAut[i].value.trim()})`);
}
}
formDataObject.personasAutorizadas = autorizados.join(', ');




const urlFoto = formDataObject.urlFotoCarnet;
const fotoFile = form.fotoCarnet.files[0];




if (!urlFoto) {
let msg = '<strong>Error:</strong> Debe seleccionar y subir una Foto Carnet (Requerida).';
if (fotoFile) {
msg =  '<strong>Error:</strong> La Foto Carnet est√° seleccionada pero a√∫n no se ha subido. Espere a que la subida finalice (‚úÖ) o vuelva a seleccionarla.' ;
}
document.getElementById('status-registro').innerHTML = `<div class="mensaje error">${msg}</div>`;
document.getElementById('submit-button').disabled = false;
document.getElementById('loader-registro').style.display = 'none';
return;
}
if (form.certificadoAptitud.files[0] && !formDataObject.urlCertificadoAptitud) {
document.getElementById('status-registro').innerHTML = `<div class="mensaje error"><strong>Error:</strong> El Certificado de Aptitud se est√° subiendo o fall√≥. Por favor, espere o vuelva a seleccionarlo.</div>`;
document.getElementById('submit-button').disabled = false;
document.getElementById('loader-registro').style.display = 'none';
return;
}


google.script.run
.withSuccessHandler(handleRegistroSuccess)
.withFailureHandler(handleRegistroFailure)
.paso1_registrarRegistro(formDataObject);
});




document.getElementById('btn-limpiar-form').addEventListener('click', function() {
if (confirm('¬øEst√° seguro de que desea reiniciar el formulario? Se perder√°n todos los datos cargados.')) {
limpiarCache();
window.top.location.href = APP_URL;
}
});




document.getElementById('registroForm').addEventListener('change', guardarFormEnCache);




document.addEventListener('DOMContentLoaded', () => {
    // Al cargar, aseguramos que haya al menos un campo de tel√©fono para que el 'required' funcione
    const telefonosExistentes = document.querySelectorAll('.telefono-area-code');
    if (telefonosExistentes.length === 0) {
        addTelefonoCampos(true); // A√±ade el primer grupo de campos REQUERIDOS
    }
   
    cargarFormDesdeCache();
    toggleEspecifique('practicaDeporte', 'especifiqueDeporte');
    toggleEspecifique('tieneEnfermedad', 'especifiqueEnfermedad');
    toggleEspecifique('esAlergico', 'especifiqueAlergia');
    toggleCantidadCuotas();
});




</script>
</body>
</html>
